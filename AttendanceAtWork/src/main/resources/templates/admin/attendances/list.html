<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>å‹¤æ€ ä¸€è¦§ - ç®¡ç†è€…ãƒšãƒ¼ã‚¸</title>
	<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen font-sans">

	<div class="container mx-auto px-6 py-8">

		<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
		<div class="flex justify-between items-center mb-8">
			<h1 class="text-3xl font-bold text-gray-800">ğŸ•’ å‹¤æ€ ä¸€è¦§</h1>
			<div>
				<button onclick="window.location.href='/admin/dashboard'"
					class="mr-2 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">â¬… ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
			</div>
		</div>

		<!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
		<div class="bg-white p-4 rounded-lg shadow mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">

			<!-- ç¤¾å“¡ãƒ•ã‚£ãƒ«ã‚¿ -->
			<div>
				<label class="block text-sm font-semibold mb-1">ç¤¾å“¡</label>
				<select id="userFilter" class="w-full border rounded-lg px-3 py-2">
					<option value="">ã™ã¹ã¦</option>
				</select>
			</div>

			<!-- éƒ¨ç½²ãƒ•ã‚£ãƒ«ã‚¿ -->
			<div>
				<label class="block text-sm font-semibold mb-1">éƒ¨ç½²</label>
				<select id="departmentFilter" class="w-full border rounded-lg px-3 py-2">
					<option value="">ï¼ˆéƒ¨ç½²ã‚’é¸æŠï¼‰</option>


					<option th:each="dept : ${departments}" th:value="${dept.departmentId}" th:text="${dept.name}">
					</option>
				</select>
			</div>

			<!-- æ—¥ä»˜ï¼ˆé–‹å§‹ï¼‰ -->
			<div>
				<label class="block text-sm font-semibold mb-1">é–‹å§‹æ—¥</label>
				<input type="date" id="startDate" class="w-full border rounded-lg px-3 py-2">
			</div>

			<!-- æ—¥ä»˜ï¼ˆçµ‚äº†ï¼‰ -->
			<div>
				<label class="block text-sm font-semibold mb-1">çµ‚äº†æ—¥</label>
				<input type="date" id="endDate" class="w-full border rounded-lg px-3 py-2">
			</div>

			<div class="md:col-span-4 flex gap-3 mt-2">
				<button id="filterBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">ğŸ”
					çµã‚Šè¾¼ã¿</button>
				<button id="resetBtn"
					class="bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500">ãƒªã‚»ãƒƒãƒˆ</button>

				<!-- å³å´ï¼šCSV & åˆ‡æ›¿ -->
				<div class="ml-auto flex gap-3">
					<button id="csvBtn" class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700">
						CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
					</button>

					<select id="rangeSwitch" class="border rounded-lg px-3 py-2">
						<option value="daily">æ—¥åˆ¥</option>
						<option value="weekly">é€±åˆ¥</option>
						<option value="monthly">æœˆåˆ¥</option>
					</select>
				</div>
			</div>
		</div>

		<!-- ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
		<div class="overflow-x-auto bg-white rounded-xl shadow">
			<table class="min-w-full divide-y divide-gray-200">
				<thead class="bg-blue-50">
					<tr>
						<th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">ç¤¾å“¡ç•ªå·</th>
						<th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">æ°å</th>
						<th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">å‡ºå‹¤</th>
						<th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">é€€å‹¤</th>
						<th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">å‹¤å‹™æ™‚é–“</th>
						<th class="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase">æ“ä½œ</th>
					</tr>
				</thead>
				<tbody id="attendanceTable" class="divide-y divide-gray-100"></tbody>
			</table>
		</div>

		<p id="noResult" class="text-center text-gray-500 mt-6 hidden">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
	</div>
	<script>
	document.addEventListener("DOMContentLoaded", () => {

	  /* -----------------------------------------
	     ğŸ”‘ JWTï¼ˆã‚ã‚Œã°ä½¿ã†ï¼‰
	  ----------------------------------------- */
	  const token = localStorage.getItem("token");

	  function authHeaders(extra = {}) {
	    const headers = { ...extra };
	    if (token) headers["Authorization"] = `Bearer ${token}`;
	    return headers;
	  }

	  /* -----------------------------------------
	     ğŸ“Œ DOM å–å¾—ï¼ˆå‹¤æ€ ä¸€è¦§ãƒšãƒ¼ã‚¸ç”¨ï¼‰
	  ----------------------------------------- */
	  const userFilter = document.getElementById("userFilter");
	  const departmentFilter = document.getElementById("departmentFilter");
	  const startDateInput = document.getElementById("startDate");
	  const endDateInput = document.getElementById("endDate");
	  const filterBtn = document.getElementById("filterBtn");
	  const resetBtn = document.getElementById("resetBtn");
	  const csvBtn = document.getElementById("csvBtn");
	  const rangeSwitch = document.getElementById("rangeSwitch");
	  const tableBody = document.getElementById("attendanceTable");
	  const noResult = document.getElementById("noResult");


	  /* -----------------------------------------
	     â˜… NEW! â‘  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ã®åˆæœŸåŒ–
	     /api/admin/users ã‚’å©ã„ã¦ç¤¾å“¡ä¸€è¦§ã‚’å…¥ã‚Œã‚‹
	  ----------------------------------------- */
	  async function loadUserFilter() {
	    const res = await fetch("/api/admin/users", {
	      headers: authHeaders()
	    });

	    if (!res.ok) {
	      console.error("ç¤¾å“¡ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—");
	      return;
	    }

	    const users = await res.json();

	    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹åˆæœŸåŒ–
	    userFilter.innerHTML = `<option value="">ã™ã¹ã¦</option>`;

	    users.forEach(u => {
	      const opt = document.createElement("option");
	      opt.value = u.userId;
	      opt.textContent = `${u.employeeNo} - ${u.name}`;
	      userFilter.appendChild(opt);
	    });
	  }


	  /* -----------------------------------------
	     ğŸ§® ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç”Ÿæˆ
	  ----------------------------------------- */
	  function buildQuery() {
	    const params = new URLSearchParams();

	    if (userFilter.value) params.append("userId", userFilter.value);
	    if (departmentFilter.value) params.append("departmentId", departmentFilter.value);
	    if (startDateInput.value) params.append("startDate", startDateInput.value);
	    if (endDateInput.value) params.append("endDate", endDateInput.value);

	    const query = params.toString();
	    return query ? "?" + query : "";
	  }


	  /* -----------------------------------------
	     ğŸ“¥ å‹¤æ€ ä¸€è¦§ãƒ­ãƒ¼ãƒ‰
	  ----------------------------------------- */
	  async function loadAttendance() {
	    const query = buildQuery();

	    const res = await fetch("/api/admin/attendances" + query, {
	      headers: authHeaders()
	    });

	    if (res.status === 401) {
	      alert("èªè¨¼ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
	      localStorage.clear();
	      window.location.href = "/admin/login";
	      return;
	    }

	    if (!res.ok) {
	      alert("å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
	      return;
	    }

	    const data = await res.json();
	    renderTable(data);
	  }


	  /* -----------------------------------------
	     ğŸ“ ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
	  ----------------------------------------- */
	  function renderTable(data) {
	    tableBody.innerHTML = "";

	    if (!data || data.length === 0) {
	      noResult.classList.remove("hidden");
	      return;
	    }
	    noResult.classList.add("hidden");

	    data.forEach(a => {
	      const totalSec = a.totalWorkSeconds ?? 0;
	      const h = Math.floor(totalSec / 3600);
	      const m = Math.floor((totalSec % 3600) / 60);

	      const tr = document.createElement("tr");
	      tr.classList.add("hover:bg-blue-50");

	      tr.innerHTML = `
	        <td class="px-6 py-4 text-sm text-gray-700">${a.employeeNo ?? "-"}</td>
	        <td class="px-6 py-4 text-sm text-gray-800">${a.userName ?? "-"}</td>
	        <td class="px-6 py-4 text-sm text-gray-600">${a.clockIn ?? "-"}</td>
	        <td class="px-6 py-4 text-sm text-gray-600">${a.clockOut ?? "-"}</td>
	        <td class="px-6 py-4 text-sm text-gray-600">
	          ${totalSec ? `${h}æ™‚é–“ ${m}åˆ†` : "-"}
	        </td>
	        <td class="px-6 py-4 text-sm text-center">
	          <button
	            class="text-blue-600 hover:text-blue-800 underline"
	            onclick="window.location.href='/admin/attendances/${a.attendanceId}/edit'">
	            ç·¨é›†
	          </button>
	        </td>
	      `;
	      tableBody.appendChild(tr);
	    });
	  }


	  /* -----------------------------------------
	     ğŸ” çµã‚Šè¾¼ã¿ãƒœã‚¿ãƒ³
	  ----------------------------------------- */
	  filterBtn.addEventListener("click", loadAttendance);

	  /* -----------------------------------------
	     ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
	  ----------------------------------------- */
	  resetBtn.addEventListener("click", () => {
	    userFilter.value = "";
	    departmentFilter.value = "";
	    startDateInput.value = "";
	    endDateInput.value = "";
	    rangeSwitch.value = "daily";
	    loadAttendance();
	  });

	  /* -----------------------------------------
	     ğŸ“¤ CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
	  ----------------------------------------- */
	  csvBtn.addEventListener("click", () => {
	    const query = buildQuery();
	    window.location.href = "/api/admin/attendances/csv" + query;
	  });

	  /* -----------------------------------------
	     ğŸ•’ åˆæœŸãƒ­ãƒ¼ãƒ‰ï¼ˆâ˜…ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ â†’ å‹¤æ€ ä¸€è¦§ï¼‰
	  ----------------------------------------- */
	  loadUserFilter().then(loadAttendance);

	});
	</script>




</body>

</html>