<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¤¾å“¡ä¸€è¦§ - ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen font-sans">
  <div class="container mx-auto px-6 py-8">

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-gray-800">ğŸ‘¥ ç¤¾å“¡ä¸€è¦§</h1>
      <div>
        <button onclick="window.location.href='/admin/dashboard'"
                class="mr-2 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition">
          â¬… ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸æˆ»ã‚‹
        </button>
        <button onclick="window.location.href='/admin/employee/register'"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
          ï¼‹ æ–°è¦ç™»éŒ²
        </button>
      </div>
    </div>

    <!-- æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="bg-white p-4 rounded-lg shadow mb-6 flex items-center gap-4">
      <input type="text" id="searchInput" placeholder="æ°åã¾ãŸã¯ç¤¾å“¡ç•ªå·ã§æ¤œç´¢"
             class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
      <button id="searchBtn"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
        ğŸ” æ¤œç´¢
      </button>
    </div>

    <!-- ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="overflow-x-auto bg-white rounded-xl shadow">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-blue-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">ç¤¾å“¡ç•ªå·</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">æ°å</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">éƒ¨ç½²</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">å…¥ç¤¾æ—¥</th>
            <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">çŠ¶æ…‹</th>
            <th class="px-6 py-3 text-center text-xs font-semibold text-gray-600 uppercase">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="employeeTable" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>

    <p id="noResult" class="text-center text-gray-500 mt-6 hidden">è©²å½“ã™ã‚‹ç¤¾å“¡ãŒã„ã¾ã›ã‚“ã€‚</p>
  </div>

  <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-40 hidden justify-center items-center">
    <div class="bg-white rounded-lg shadow-lg p-6 w-96">
      <h2 class="text-lg font-bold mb-4">âš  å‰Šé™¤ç¢ºèª</h2>
      <p class="text-sm text-gray-700 mb-6">ã“ã®ç¤¾å“¡ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ<br><span id="deleteName" class="font-semibold text-gray-900"></span></p>
      <div class="flex justify-end gap-3">
        <button id="cancelDelete" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">å‰Šé™¤</button>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    if (!token) {
      alert("ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
      window.location.href = "/admin/login";
    }

    const tableBody = document.getElementById("employeeTable");
    const noResult = document.getElementById("noResult");
    const modal = document.getElementById("deleteModal");
    const deleteName = document.getElementById("deleteName");
    let deleteTargetId = null;

    // âœ… ç¤¾å“¡ä¸€è¦§ã‚’å–å¾—ã—ã¦æç”»
    async function loadEmployees() {
      const res = await fetch("/api/admin/users", {
        headers: { "Authorization": `Bearer ${token}` }
      });

      if (!res.ok) {
        alert("ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚");
        localStorage.clear();
        window.location.href = "/admin/login";
        return;
      }

      const users = await res.json();
      renderTable(users);

      document.getElementById("searchBtn").addEventListener("click", () => {
        const keyword = document.getElementById("searchInput").value.toLowerCase();
        const filtered = users.filter(u =>
          u.name.toLowerCase().includes(keyword) ||
          u.employeeNo.toLowerCase().includes(keyword)
        );
        renderTable(filtered);
      });
    }

    // âœ… ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderTable(data) {
      tableBody.innerHTML = "";
      if (data.length === 0) {
        noResult.classList.remove("hidden");
        return;
      }
      noResult.classList.add("hidden");

      data.forEach(u => {
        const tr = document.createElement("tr");
        tr.classList.add("hover:bg-blue-50", "cursor-pointer");

        // âœ… è¡Œã‚¯ãƒªãƒƒã‚¯ â†’ è©³ç´°ãƒšãƒ¼ã‚¸ã¸
        tr.addEventListener("click", (e) => {
          if (!e.target.closest(".action-btn")) { // æ“ä½œãƒœã‚¿ãƒ³ã¯é™¤å¤–
            window.location.href = `/admin/employee/detail/${u.userId}`;
          }
        });

        tr.innerHTML = `
          <td class="px-6 py-4 text-sm text-gray-700">${u.employeeNo}</td>
          <td class="px-6 py-4 text-sm font-medium text-gray-800">${u.name}</td>
          <td class="px-6 py-4 text-sm text-gray-600">${u.departmentName || "-"}</td>
          <td class="px-6 py-4 text-sm text-gray-600">${u.hireDate || "-"}</td>
          <td class="px-6 py-4 text-sm">
            <span class="px-2 py-1 rounded-full text-xs font-semibold ${u.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-600'}">
              ${u.status === 'active' ? 'åœ¨è·' : 'é€€è·'}
            </span>
          </td>
          <td class="px-6 py-4 text-sm text-center">
            <button class="action-btn text-blue-600 hover:text-blue-800 font-semibold mr-3"
                    onclick="editUser(event, ${u.userId})">ç·¨é›†</button>
            <button class="action-btn text-red-600 hover:text-red-800 font-semibold"
                    onclick="confirmDeleteUser(event, ${u.userId}, '${u.name}')">å‰Šé™¤</button>
          </td>
        `;
        tableBody.appendChild(tr);
      });
    }

    // âœ… ç·¨é›†
    function editUser(event, userId) {
      event.stopPropagation();
      window.location.href = `/admin/employee/edit/${userId}`;
    }

    // âœ… å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    function confirmDeleteUser(event, userId, name) {
      event.stopPropagation();
      deleteTargetId = userId;
      deleteName.textContent = name;
      modal.classList.remove("hidden", "opacity-0");
      modal.classList.add("flex");
    }

    // âœ… å‰Šé™¤ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    document.getElementById("cancelDelete").addEventListener("click", () => {
      modal.classList.add("hidden");
    });

    // âœ… å‰Šé™¤ç¢ºå®š
    document.getElementById("confirmDelete").addEventListener("click", async () => {
      if (!deleteTargetId) return;
      const res = await fetch(`/api/admin/users/${deleteTargetId}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (res.ok) {
        alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
        modal.classList.add("hidden");
        loadEmployees();
      } else {
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    });

    loadEmployees();
  </script>
</body>
</html>
